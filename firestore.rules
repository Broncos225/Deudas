
/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a combination of user-based ownership and shared access models.
 *
 * Data Structure:
 * - User-specific data (debtors, categories) is nested under `/users/{userId}`.
 * - Shared data (debts, settlements, activity logs) is in top-level collections.
 * - Personal debt metadata (like categories) is in `/debt_user_metadata`.
 *
 * Key Security Decisions:
 * - User-specific data is strictly controlled by the owning user.
 * - Shared debts and settlements require a `participants` array for access control.
 * - Public listing of collections is disallowed to protect privacy.
 *
 * Denormalization for Authorization:
 * - Shared debts and settlements use a `participants` array to simplify access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants the user full ownership over their debtor documents.
     */
    match /users/{userId}/debtors/{debtorId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants the user full ownership over their debt categories.
     */
    match /users/{userId}/categories/{categoryId} {
        allow get, list, delete: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
    }


    /**
     * @description Grants the user ownership over their private debt documents.
     */
    match /users/{userId}/debts/{debtId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces shared access control based on the `participants` array for shared debts.
     */
    match /debts_shared/{debtId} {
      allow get: if isSignedIn() && resource.data.participants.hasAny([request.auth.uid]);
      allow list: if isSignedIn();
      allow create: if isSignedIn() && 
                       request.resource.data.participants.size() == 2 &&
                       request.resource.data.status == 'pending';
      allow update: if isSignedIn() && resource != null && resource.data.participants.hasAny([request.auth.uid]);
      allow delete: if isSignedIn() && resource != null && resource.data.participants.hasAny([request.auth.uid]);
    }

    /**
     * @description Enforces shared access control for settlement proposals.
     */
    match /settlements/{settlementId} {
      allow get: if isSignedIn() && resource.data.participants.hasAny([request.auth.uid]);
      allow list: if isSignedIn();
      allow create: if isSignedIn() && 
                       request.resource.data.proposerId == request.auth.uid &&
                       request.resource.data.participants.hasAll([request.auth.uid]);
      allow update: if isSignedIn() && resource.data.participants.hasAny([request.auth.uid]);
      allow delete: if isSignedIn() && resource.data.participants.hasAny([request.auth.uid]) && (resource.data.status == 'pending' || resource.data.status == 'reversal_pending');
    }

    /**
     * @description Allows listing activity logs only when filtering by user.
     */
    match /activity_logs/{logId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants the user ownership over their debt metadata documents.
     */
    match /debt_user_metadata/{metadataId} {
      allow list: if isSignedIn();
      allow get, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create, update: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }
  }

  // Helper function to determine if the user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the user is the owner of the document.
  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  // Helper function to determine if the user is the owner of the document and the resource exists.
  function isExistingOwner(userId) {
      return isSignedIn() && isOwner(userId) && resource != null;
  }
}
